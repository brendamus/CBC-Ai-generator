{% extends "admin/base_admin.html" %}
{% block title %}Manage Sub-Strands{% endblock %}

{% block content %}
{# Pass strands from Flask route #}
<div x-data="substrandManager({{ strands | tojson }})" x-init="fetchSubStrands()">

    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Sub-Strands</h2>
    <div x-show="message" x-text="message" x-transition :class="{ 'bg-green-100 border border-green-400 text-green-700': messageType === 'success', 'bg-red-100 border border-red-400 text-red-700': messageType === 'error' }" class="px-4 py-3 rounded relative mb-4" role="alert"></div>

    <div x-show="showForm" x-transition x-cloak class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-xl font-semibold mb-4" x-text="formTitle()"></h3>
        <form @submit.prevent="saveSubStrand">
            <input type="hidden" x-model="formData.id">
            {# --- Select Parent Strand --- #}
            <div class="mb-4">
                 <label for="substrandParentStrand" class="block text-sm font-medium text-gray-700 mb-1">Parent Strand</label>
                 <select id="substrandParentStrand" x-model="formData.strand_id" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                      <option value="">-- Select Parent Strand --</option>
                      {# Loop through strands passed from Flask route #}
                      <template x-for="strand in strands" :key="strand.id">
                           {# Display strand name along with subject/grade for clarity #}
                           <option :value="strand.id" x-text="`${strand.name} (ID: ${strand.id})`"></option>
                           {# You might need more info like Subject/Grade name here - requires passing more data from Flask #}
                      </template>
                 </select>
            </div>
             {# --- SubStrand Name --- #}
            <div class="mb-4">
                <label for="substrandName" class="block text-sm font-medium text-gray-700 mb-1">Sub-Strand Name</label>
                <input type="text" id="substrandName" x-model="formData.name" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            {# --- Buttons --- #}
            <div class="flex justify-end space-x-3">
                 <button type="button" @click="cancelForm()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded">Cancel</button>
                 <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded" :disabled="loading">
                    <span x-show="!loading" x-text="formSubmitButtonText()"></span><span x-show="loading">Saving...</span>
                 </button>
            </div>
        </form>
    </div>

    <div class="mb-4"><button @click="showAddForm()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded shadow">+ Add New Sub-Strand</button></div>

    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
         <div x-show="loading && items.length === 0" class="text-center py-4">Loading sub-strands...</div>
         <table class="min-w-full divide-y divide-gray-200" x-show="items.length > 0">
            <thead class="bg-gray-50">
                 <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Strand ID</th>
                      <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                 </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="item in items" :key="item.id">
                    <tr>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="item.id"></td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="item.name"></td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.strand_id"></td>
                         <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                              <button @click="showEditForm(item)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                              <button @click="confirmDelete(item)" class="text-red-600 hover:text-red-900">Delete</button>
                         </td>
                    </tr>
                </template>
            </tbody>
        </table>
        <div x-show="!loading && items.length === 0 && !message" class="text-center py-4 text-gray-500">No sub-strands found.</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function substrandManager(strandsData) { // Receive strands from Flask
    return {
        strands: strandsData || [], // Store parent strands
        items: [], // This will hold substrands
        showForm: false, isEditing: false, loading: false, message: '', messageType: 'success',
        formData: { id: null, name: '', strand_id: '' }, // Form data model
        formTitle() { return this.isEditing ? 'Edit Sub-Strand' : 'Add New Sub-Strand'; },
        formSubmitButtonText() { return this.isEditing ? 'Update Sub-Strand' : 'Save Sub-Strand'; },
        showMessage(msg, type = 'success', duration = 3000) { this.message=msg; this.messageType=type; setTimeout(()=>{this.message='';},duration); },
        async fetchSubStrands() { // Fetch the list of substrands
            this.loading = true; this.message = '';
            try {
                // Assuming GET /api/substrands?all=true returns all substrands
                // You might need to adjust this API endpoint or implement filtering/pagination later
                const response = await fetch('/api/substrands?all=true');
                if (!response.ok) throw new Error(`Error fetching sub-strands: ${response.statusText}`);
                this.items = await response.json();
            } catch (error) { this.showMessage(error.message || 'Failed to load sub-strands.', 'error'); }
            finally { this.loading = false; }
        },
        showAddForm() { this.isEditing = false; this.formData = { id: null, name: '', strand_id: '' }; this.showForm = true; this.message = ''; },
        showEditForm(item) { this.isEditing = true; this.formData = { ...item }; this.showForm = true; this.message = ''; },
        cancelForm() { this.showForm = false; this.formData = { id: null, name: '', strand_id: '' }; this.isEditing = false; },
        async saveSubStrand() {
            this.loading = true; this.message = '';
            const url = this.isEditing ? `/api/substrands/${this.formData.id}` : '/api/substrands';
            const method = this.isEditing ? 'PUT' : 'POST';
            const payload = {
                name: this.formData.name,
                strand_id: this.formData.strand_id // Ensure this is selected
            };
            if (!payload.strand_id) { this.showMessage('Parent Strand is required.','error'); this.loading=false; return; }

            try {
                const response = await fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `${method} request failed`);
                this.showMessage(`Sub-Strand successfully ${this.isEditing ? 'updated' : 'added'}!`, 'success');
                this.cancelForm();
                await this.fetchSubStrands(); // Refresh list
            } catch (error) { this.showMessage(error.message || 'Failed to save sub-strand.', 'error'); }
            finally { this.loading = false; }
        },
        confirmDelete(item) { if (confirm(`Delete Sub-Strand "${item.name}"?`)) { this.deleteSubStrand(item.id); } },
        async deleteSubStrand(id) {
            this.loading = true; this.message = '';
            try {
                const response = await fetch(`/api/substrands/${id}`, { method: 'DELETE' });
                if (!response.ok) { let em='Error deleting'; try{const ed=await response.json();em=ed.error||em;}catch{}; throw new Error(em); }
                this.showMessage('Sub-Strand deleted successfully!', 'success');
                await this.fetchSubStrands(); // Refresh list
            } catch (error) { this.showMessage(error.message || 'Failed to delete sub-strand.', 'error'); }
            finally { this.loading = false; }
        }
    }
}
</script>
{% endblock %}