{% extends "admin/base_admin.html" %}
{% block title %}Manage Learning Outcomes{% endblock %}

{% block content %}
{# Pass substrands from Flask route #}
<div x-data="learningOutcomeManager({{ substrands | tojson }})" x-init="fetchLearningOutcomes()">

    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Learning Outcomes</h2>
    <div x-show="message" x-text="message" x-transition :class="{ 'bg-green-100 ...': messageType === 'success', 'bg-red-100 ...': messageType === 'error' }" class="px-4 py-3 rounded relative mb-4" role="alert"></div>

    <div x-show="showForm" x-transition x-cloak class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-xl font-semibold mb-4" x-text="formTitle()"></h3>
        <form @submit.prevent="saveLearningOutcome">
            <input type="hidden" x-model="formData.id">
            {# --- Select Parent SubStrand --- #}
            <div class="mb-4">
                 <label for="loParentSubStrand" class="block text-sm font-medium text-gray-700 mb-1">Parent Sub-Strand</label>
                 <select id="loParentSubStrand" x-model="formData.substrand_id" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                      <option value="">-- Select Parent Sub-Strand --</option>
                      {# Loop through substrands passed from Flask route #}
                      <template x-for="substrand in substrands" :key="substrand.id">
                           <option :value="substrand.id" x-text="`${substrand.name} (ID: ${substrand.id})`"></option>
                           {# Consider adding Strand/Subject/Grade info here for clarity #}
                      </template>
                 </select>
            </div>
             {# --- Learning Outcome Description --- #}
            <div class="mb-4">
                <label for="loDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="loDescription" x-model="formData.description" required rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            {# --- Buttons --- #}
            <div class="flex justify-end space-x-3">
                 <button type="button" @click="cancelForm()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded">Cancel</button>
                 <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded" :disabled="loading">
                    <span x-show="!loading" x-text="formSubmitButtonText()"></span><span x-show="loading">Saving...</span>
                 </button>
            </div>
        </form>
    </div>

    <div class="mb-4"><button @click="showAddForm()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded shadow">+ Add New Learning Outcome</button></div>

    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
         <div x-show="loading && items.length === 0" class="text-center py-4">Loading learning outcomes...</div>
         <table class="min-w-full divide-y divide-gray-200" x-show="items.length > 0">
            <thead class="bg-gray-50">
                 <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub-Strand ID</th>
                      <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                 </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="item in items" :key="item.id">
                    <tr>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="item.id"></td>
                         <td class="px-6 py-4 text-sm text-gray-700" x-text="item.description.length > 100 ? item.description.substring(0, 100) + '...' : item.description"></td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.substrand_id"></td>
                         <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                              <button @click="showEditForm(item)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                              <button @click="confirmDelete(item)" class="text-red-600 hover:text-red-900">Delete</button>
                         </td>
                    </tr>
                </template>
            </tbody>
        </table>
        <div x-show="!loading && items.length === 0 && !message" class="text-center py-4 text-gray-500">No learning outcomes found.</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function learningOutcomeManager(substrandsData) { // Receive substrands from Flask
    return {
        substrands: substrandsData || [], // Store parent substrands
        items: [], // This will hold learning outcomes
        showForm: false, isEditing: false, loading: false, message: '', messageType: 'success',
        formData: { id: null, description: '', substrand_id: '' }, // Form data model
        formTitle() { return this.isEditing ? 'Edit Learning Outcome' : 'Add New Learning Outcome'; },
        formSubmitButtonText() { return this.isEditing ? 'Update Learning Outcome' : 'Save Learning Outcome'; },
        showMessage(msg, type = 'success', duration = 3000) { this.message=msg; this.messageType=type; setTimeout(()=>{this.message='';},duration); },
        async fetchLearningOutcomes() { // Fetch the list of learning outcomes
            this.loading = true; this.message = '';
            try {
                // Assuming GET /api/learning_outcomes?all=true returns all
                const response = await fetch('/api/learning_outcomes?all=true');
                if (!response.ok) throw new Error(`Error fetching learning outcomes: ${response.statusText}`);
                this.items = await response.json();
            } catch (error) { this.showMessage(error.message || 'Failed to load learning outcomes.', 'error'); }
            finally { this.loading = false; }
        },
        showAddForm() { this.isEditing = false; this.formData = { id: null, description: '', substrand_id: '' }; this.showForm = true; this.message = ''; },
        showEditForm(item) { this.isEditing = true; this.formData = { ...item }; this.showForm = true; this.message = ''; },
        cancelForm() { this.showForm = false; this.formData = { id: null, description: '', substrand_id: '' }; this.isEditing = false; },
        async saveLearningOutcome() {
            this.loading = true; this.message = '';
            const url = this.isEditing ? `/api/learning_outcomes/${this.formData.id}` : '/api/learning_outcomes';
            const method = this.isEditing ? 'PUT' : 'POST';
            const payload = {
                description: this.formData.description,
                substrand_id: this.formData.substrand_id // Ensure this is selected
            };
            if (!payload.substrand_id) { this.showMessage('Parent Sub-Strand is required.','error'); this.loading=false; return; }

            try {
                const response = await fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `${method} request failed`);
                this.showMessage(`Learning Outcome successfully ${this.isEditing ? 'updated' : 'added'}!`, 'success');
                this.cancelForm();
                await this.fetchLearningOutcomes(); // Refresh list
            } catch (error) { this.showMessage(error.message || 'Failed to save learning outcome.', 'error'); }
            finally { this.loading = false; }
        },
        confirmDelete(item) { if (confirm(`Delete Learning Outcome (ID: ${item.id})? "${item.description.substring(0,50)}..."`)) { this.deleteLearningOutcome(item.id); } },
        async deleteLearningOutcome(id) {
            this.loading = true; this.message = '';
            try {
                const response = await fetch(`/api/learning_outcomes/${id}`, { method: 'DELETE' });
                if (!response.ok) { let em='Error deleting'; try{const ed=await response.json();em=ed.error||em;}catch{}; throw new Error(em); }
                this.showMessage('Learning Outcome deleted successfully!', 'success');
                await this.fetchLearningOutcomes(); // Refresh list
            } catch (error) { this.showMessage(error.message || 'Failed to delete learning outcome.', 'error'); }
            finally { this.loading = false; }
        }
    }
}
</script>
{% endblock %}