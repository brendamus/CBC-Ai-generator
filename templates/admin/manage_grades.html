{% extends "admin/base_admin.html" %}
{% block title %}Manage Grades{% endblock %}

{% block content %}
<div x-data="gradeManager()" x-init="fetchGrades()">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Grades</h2>
    <div x-show="message" x-text="message" x-transition :class="{ 'bg-green-100 ...': messageType === 'success', 'bg-red-100 ...': messageType === 'error' }" class="px-4 py-3 rounded relative mb-4" role="alert"></div>
    <div x-show="showForm" x-transition x-cloak class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="text-xl font-semibold mb-4" x-text="formTitle()"></h3>
        <form @submit.prevent="saveGrade">
            <input type="hidden" x-model="formData.id">
            <div class="mb-4">
                <label for="gradeName" class="block text-sm font-medium text-gray-700 mb-1">Grade Name</label>
                <input type="text" id="gradeName" x-model="formData.name" required class="w-full p-2 border ...">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" @click="cancelForm()" class="bg-gray-200 ...">Cancel</button>
                <button type="submit" class="bg-indigo-600 ..." :disabled="loading">
                    <span x-show="!loading" x-text="formSubmitButtonText()"></span><span x-show="loading">Saving...</span>
                </button>
            </div>
        </form>
    </div>
    <div class="mb-4"><button @click="showAddForm()" class="bg-green-600 ...">+ Add New Grade</button></div>
    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
        <div x-show="loading && items.length === 0" class="text-center py-4">Loading grades...</div>
        <table class="min-w-full ..." x-show="items.length > 0">
            <thead class="bg-gray-50"><tr><th ...>ID</th><th ...>Name</th><th ...>Actions</th></tr></thead>
            <tbody class="bg-white divide-y ...">
                <template x-for="item in items" :key="item.id">
                    <tr>
                        <td ... x-text="item.id"></td><td ... x-text="item.name"></td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button @click="showEditForm(item)" class="text-indigo-600 ...">Edit</button>
                            <button @click="confirmDelete(item)" class="text-red-600 ...">Delete</button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
        <div x-show="!loading && items.length === 0 && !message" class="text-center py-4 text-gray-500">No grades found.</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- AlpineJS Data for Grades (Similar to Subjects) ---
function gradeManager() {
    return {
        items: [], showForm: false, isEditing: false, loading: false, message: '', messageType: 'success',
        formData: { id: null, name: '' },
        formTitle() { return this.isEditing ? 'Edit Grade' : 'Add New Grade'; },
        formSubmitButtonText() { return this.isEditing ? 'Update Grade' : 'Save Grade'; },
        showMessage(msg, type = 'success', duration = 3000) { /* ... same ... */ this.message=msg; this.messageType=type; setTimeout(()=>{this.message='';},duration); },
        async fetchGrades() { this.loading = true; this.message = ''; try { const r = await fetch('/api/grades'); if (!r.ok) throw new Error(`Err: ${r.statusText}`); this.items = await r.json(); } catch (e) { this.showMessage(e.message||'Failed load','error'); } finally { this.loading=false;} },
        showAddForm() { this.isEditing = false; this.formData = { id: null, name: '' }; this.showForm = true; this.message = ''; },
        showEditForm(item) { this.isEditing = true; this.formData = { ...item }; this.showForm = true; this.message = ''; },
        cancelForm() { this.showForm = false; this.formData = { id: null, name: '' }; this.isEditing = false; },
        async saveGrade() { this.loading = true; this.message = ''; const url = this.isEditing ? `/api/grades/${this.formData.id}` : '/api/grades'; const method = this.isEditing ? 'PUT' : 'POST'; try { const r = await fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: this.formData.name }) }); const d = await r.json(); if (!r.ok) throw new Error(d.error || `${method} fail`); this.showMessage(`Grade ${this.isEditing ? 'upd':'add'}!`, 'success'); this.cancelForm(); await this.fetchGrades(); } catch (e) { this.showMessage(e.message||'Fail save','error'); } finally { this.loading=false; } },
        confirmDelete(item) { if (confirm(`Delete "${item.name}"?`)) { this.deleteGrade(item.id); } },
        async deleteGrade(id) { this.loading = true; this.message = ''; try { const r = await fetch(`/api/grades/${id}`, { method: 'DELETE' }); if (!r.ok) { let em='Err del'; try{const ed=await r.json();em=ed.error||em;}catch{}; throw new Error(em); } this.showMessage('Grade del!', 'success'); await this.fetchGrades(); } catch (e) { this.showMessage(e.message||'Fail del','error'); } finally { this.loading=false;} }
    }
}
</script>
{% endblock %}